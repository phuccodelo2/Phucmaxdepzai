-- PHUCMAX Camlock + Teleport + Vòng quanh NPC2 + UI máu + Auto Click + Tool Check
-- by Copilot

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")
local lp = Players.LocalPlayer
local cam = workspace.CurrentCamera

local function notify(t, tx)
    pcall(function()
        StarterGui:SetCore("SendNotification", {Title = t; Text = tx; Duration = 4})
    end)
end

local function getNPC()
    for _,obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("Model") and obj.Name == "NPC2" and obj:FindFirstChild("HumanoidRootPart") then
            return obj
        end
    end
    return nil
end

local function getNPCHealth()
    local npc = getNPC()
    if npc then
        local hum = npc:FindFirstChildOfClass("Humanoid")
        if hum then
            return hum.Health, hum.MaxHealth
        end
    end
    return 0, 0
end

-- UI
local gui = Instance.new("ScreenGui")
gui.Name = "PHUCMAX_UI"
gui.ResetOnSpawn = false
pcall(function() gui.Parent = game:GetService("CoreGui") end)
if not gui.Parent then gui.Parent = lp:WaitForChild("PlayerGui") end

local frame = Instance.new("Frame")
frame.Parent = gui
frame.Size = UDim2.fromOffset(250, 110)
frame.Position = UDim2.new(0.07, 0, 0.25, 0)
frame.BackgroundColor3 = Color3.fromRGB(20,20,25)
frame.BackgroundTransparency = 0.1
frame.BorderSizePixel = 0
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 20)
local stroke = Instance.new("UIStroke", frame)
stroke.Thickness = 2.5

local title = Instance.new("TextLabel")
title.Parent = frame
title.Size = UDim2.new(1, -20, 0, 36)
title.Position = UDim2.fromOffset(10, 6)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextScaled = true
title.Text = "phucmax camlock NPC2"
title.TextColor3 = Color3.fromRGB(255,255,255)

local btn = Instance.new("TextButton")
btn.Parent = frame
btn.Size = UDim2.new(1, -20, 0, 48)
btn.Position = UDim2.fromOffset(10, 52)
btn.BackgroundColor3 = Color3.fromRGB(35,35,45)
btn.AutoButtonColor = true
btn.Text = "Farm Camlock: OFF"
btn.Font = Enum.Font.GothamBold
btn.TextScaled = true
btn.TextColor3 = Color3.fromRGB(220,220,220)
Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 16)
local btnStroke = Instance.new("UIStroke", btn)
btnStroke.Thickness = 1.8

-- UI Máu quái góc phải
local healthFrame = Instance.new("Frame")
healthFrame.Parent = gui
healthFrame.Size = UDim2.fromOffset(220, 42)
healthFrame.Position = UDim2.new(1, -230, 1, -54) -- Góc phải dưới
healthFrame.AnchorPoint = Vector2.new(0,1)
healthFrame.BackgroundColor3 = Color3.fromRGB(30,30,45)
healthFrame.BackgroundTransparency = 0.12
healthFrame.BorderSizePixel = 0
Instance.new("UICorner", healthFrame).CornerRadius = UDim.new(0, 14)

local healthLbl = Instance.new("TextLabel")
healthLbl.Parent = healthFrame
healthLbl.Size = UDim2.new(1, -16, 1, -12)
healthLbl.Position = UDim2.fromOffset(8, 6)
healthLbl.BackgroundTransparency = 1
healthLbl.Font = Enum.Font.GothamBold
healthLbl.TextScaled = true
healthLbl.Text = "HP: -- / --"
healthLbl.TextColor3 = Color3.fromRGB(255,80,80)

local healthStroke = Instance.new("UIStroke", healthFrame)
healthStroke.Thickness = 2

-- Drag UI
do
    local dragging, dragStart, startPos
    frame.InputBegan:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = i.Position
            startPos = frame.Position
        end
    end)
    frame.InputEnded:Connect(function(i)
        if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
    game:GetService("UserInputService").InputChanged:Connect(function(i)
        if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
            local delta = i.Position - dragStart
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
end

-- Rainbow
local hue = 0
RunService.RenderStepped:Connect(function(dt)
    hue = (hue + dt*0.15) % 1
    local col = Color3.fromHSV(hue, 1, 1)
    stroke.Color = col
    btnStroke.Color = col
    title.TextColor3 = col
    healthStroke.Color = col
    healthLbl.TextColor3 = col
end)

-- UI cập nhật máu quái liên tục
RunService.RenderStepped:Connect(function()
    local hp, maxhp = getNPCHealth()
    if maxhp > 0 then
        healthLbl.Text = string.format("HP: %d / %d", hp, maxhp)
    else
        healthLbl.Text = "HP: -- / --"
    end
end)

-- Camlock & Farm Logic
local farming = false
local farmLoop = nil

local function camLockToNPC(npc)
    local head = npc:FindFirstChild("Head") or npc:FindFirstChild("HumanoidRootPart")
    if head then
        cam.CameraType = Enum.CameraType.Scriptable
        cam.CFrame = CFrame.new(cam.CFrame.Position, head.Position)
    end
end

local function lookAtNPC(char, npc)
    local myHRP = char:FindFirstChild("HumanoidRootPart")
    local targetHRP = npc:FindFirstChild("HumanoidRootPart")
    if myHRP and targetHRP then
        myHRP.CFrame = CFrame.new(myHRP.Position, targetHRP.Position)
    end
end

-- Giữ bám trên đầu NPC2 không rớt xuống đất
local function stickToHead(char, npc, duration)
    local myHRP = char:FindFirstChild("HumanoidRootPart")
    local targetHRP = npc:FindFirstChild("HumanoidRootPart")
    if not myHRP or not targetHRP then return end
    local start = tick()
    while tick() - start < duration do
        local posAbove = targetHRP.Position + Vector3.new(0,5,0)
        myHRP.CFrame = CFrame.new(posAbove, targetHRP.Position)
        camLockToNPC(npc)
        lookAtNPC(char, npc)
        task.wait(0.03)
    end
end


-- Auto click không chiếm chuột thật
local function autoClick(toolName)
    local char = lp.Character
    if not char then return end
    local tool = nil
    for _,v in pairs(char:GetChildren()) do
        if v:IsA("Tool") and v.Name == toolName then
            tool = v
            break
        end
    end
    if tool then
        -- Gọi hàm Activate của tool, không cần click thật
        pcall(function()
            tool:Activate()
        end)
    end
end

local function smartFarm()
    local npc = getNPC()
    if not npc then
        notify("PHUCMAX", "Không tìm thấy NPC2")
        return
    end
    local char = lp.Character
    if not char then return end
    local myHRP = char:FindFirstChild("HumanoidRootPart")
    local targetHRP = npc:FindFirstChild("HumanoidRootPart")
    if not myHRP or not targetHRP then return end

    -- Đảm bảo đã cầm tool "phonglon"
    if not hasToolEquipped("phonglon") then
        local ok = equipTool("phonglon")
        if not ok then
            notify("PHUCMAX", "Không tìm thấy tool: phonglon")
            return
        end
        task.wait(0.2)
    end

    -- Tele lên đầu quái cách 5 studs, giữ bám trên đầu 3s
    stickToHead(char, npc, 3)

    -- Chờ 0.1s rồi xuống đất cách xa 17 studs
    task.wait(0.1)
    local dir = (myHRP.Position - targetHRP.Position).Unit
    local posFar = targetHRP.Position + dir * 17
    posFar = Vector3.new(posFar.X, workspace.FallenPartsDestroyHeight + 3, posFar.Z)
    myHRP.CFrame = CFrame.new(posFar, targetHRP.Position)
    camLockToNPC(npc)
    lookAtNPC(char, npc)

    -- Xoay vòng quanh quái cực nhanh
    local radius = 17
    local rotations = 1.5
    local speed = 25
    local steps = math.floor(rotations * 360 / 10)
    for i = 1, steps do
        local angle = math.rad(i * 10 * speed)
        local offset = Vector3.new(math.cos(angle)*radius, 2, math.sin(angle)*radius)
        local pos = targetHRP.Position + offset
        myHRP.CFrame = CFrame.new(pos, targetHRP.Position)
        camLockToNPC(npc)
        lookAtNPC(char, npc)
        autoClick("phonglon") -- auto click mỗi vòng
        task.wait(0.01)
    end
end

local function farmMainLoop()
    while farming do
        smartFarm()
        task.wait(0.2)
    end
end

local function turnOn()
    farming = true
    btn.Text = "Farm Camlock: ON"
    cam.CameraType = Enum.CameraType.Scriptable
    farmLoop = task.spawn(farmMainLoop)
    notify("PHUCMAX", "Farm Camlock + Vòng quanh NPC2 ON")
end

local function turnOff()
    farming = false
    btn.Text = "Farm Camlock: OFF"
    cam.CameraType = Enum.CameraType.Custom
    if farmLoop then
        task.cancel(farmLoop)
        farmLoop = nil
    end
    notify("PHUCMAX", "Farm Camlock OFF")
end

btn.MouseButton1Click:Connect(function()
    if farming then turnOff() else turnOn() end
end)

notify("PHUCMAX", "UI bật xong. Nhấn để Farm Camlock NPC2.")
